{
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",

  "config": {
    "view": {
      "width": 100,
      "stroke": "transparent"
    }
  },

  "data": {
    "url": "../../data/vis1-data/death-counts.csv",
    "format": {
      "type": "csv",
      "parse": {
        "year": "number",
        "age_group": "number",
        "count": "number"
      }
    }
  },
  "transform": [
    {
      "impute": "count",
      "key": "age_group",
      "keyvals": { "stop": 17 },
      "groupby": ["year", "gender"]
    },
    {
      "calculate": "if(datum.year == 2018, 2017, datum.year) + '-' + datum.gender + '-' + datum.age_group",
      "as": "census_key"
    },
    {
      "lookup": "census_key",
      "from": {
        "key": "key",
        "fields": ["count"],
        "data": {
          "url": "../../data/vis1-data/census-counts.csv"
        }
      },
      "as": ["census_count"],
      "default": "0"
    },
    {
      "calculate": "toNumber(datum.census_count)",
      "as": "census_count"
    },
    {
      "joinaggregate": [
        {
          "op": "sum",
          "field": "count",
          "as": "total_count"
        }
      ],
      "groupby": ["year"]
    },
    {
      "joinaggregate": [
        {
          "op": "sum",
          "field": "census_count",
          "as": "total_census_count"
        }
      ],
      "groupby": ["year", "gender"]
    },
    {
      "calculate": "datum.count / datum.total_count",
      "as": "percentage"
    },
    {
      "calculate": "datum.census_count / (datum.total_census_count || 1)",
      "as": "census_percentage"
    }
  ],
  
  "facet": {
    "field": "year",
    "title": null,
    "header": {"labelFontSize": 15},
    "sort": "descending" 
  },
  "columns": 3,
  "spec": {
    "bounds": "flush",
    "spacing": 0,

    "hconcat": [
      {
        "data": {
          "sequence": {
            "start": 0,
            "stop": 90,
            "step": 5,
            "as": "low"
          }
        },
        "transform": [
          {
            "calculate": "if(datum.low < 85, datum.low + '-' + (datum.low + 4), '85+')",
            "as": "label"
          }
        ],

        "mark": "text",
        "encoding": {
          "text": {
            "type": "ordinal",
            "field": "label"
          },
          "y": {
            "type": "ordinal",
            "field": "low",
            "axis": null,
            "scale": { "reverse": true }
          }
        }
      },
      {
        "transform": [
          {
            "filter": {
              "field": "gender",
              "equal": "M"
            }
          }
        ],

        "layer": [
          {
            "selection": {
              "year": {
                "type": "multi",
                "fields": [
                  "year"
                ],
                "bind": {
                  "legend": "dblclick"
                },
                "init": [

                ]
              },
              "gender": {
                "type": "multi",
                "fields": [
                  "gender"
                ],
                "bind": {
                  "legend": "dblclick"
                },
                "init": [

                ]
              }
            },
            "mark": "bar",
            "encoding": {
              "x": {
                "title": "Percent",
                "type": "quantitative",
                "field": "percentage",
                "sort": "descending",
                "axis": {
                  "format": ".1%",
                  "grid": false,
                  "labelFlush": false,
                  "labels": true,
                  "offset": 360
                },
                "scale": {"domain": [0,0.13]}
              },
              "y": {
                "title": null,
                "type": "ordinal",
                "field": "age_group",
                "axis": {
                  "labels": false
                }
              },
              "color": {
                "field": "gender",
                "scale": {"range": ["#DA5E8C", "#586CBB"]}
              },
              "opacity": {
                "condition": {"selection": "gender", "value": 1},
                "value": 0
              }
            }
          },
          {
            "mark": "bar",
            "encoding": {
              "x": {
                "title": "",
                "type": "quantitative",
                "field": "census_percentage",
                "sort": "descending",
                "axis": {
                  "format": ".1%",
                  "grid": false,
                  "labelFlush": false,
                  "labels": true
                },
                "scale": {"domain": [0,0.13]}
              },
              "y": {
                "title": null,
                "type": "ordinal",
                "field": "age_group",
                "axis": {
                  "labels": false
                }
              },
              "stroke": {
                "value": "black"
              },
              "strokeWidth": {
                "value": 2
              },
              "fillOpacity": {
                "value": 0
              }
            }
          }
        ],
        "encoding": {
          "tooltip": [
            {
              "format": ".1%",
              "type": "quantitative",
              "field": "percentage"
            },
            {
              "format": ".1%",
              "type": "quantitative",
              "field": "census_percentage"
            }
          ]
        },

        "resolve": {
          "scale": {
            "x": "shared",
            "y": "shared"
          }
        }
      },
      {
        "transform": [
          {
            "filter": {
              "field": "gender",
              "equal": "F"
            }
          }
        ],

        "layer": [
          {
            "mark": "bar",
            "encoding": {
              "x": {
                "title": null,
                "type": "quantitative",
                "field": "percentage",
                "sort": "ascending",
                "axis": {
                  "format": ".1%",
                  "grid": false,
                  "labelFlush": false,
                  "labels": true,
                  "offset": 360
                },
                "scale": {"domain": [0,0.13]}
              },
              "y": {
                "title": null,
                "type": "ordinal",
                "field": "age_group",
                "axis": null
              },
              "color": {
                "field": "gender"
              },
              "opacity": {
                "condition": {"selection": "gender", "value": 1},
                "value": 0
              }
            }
          },
          {
            "mark": "bar",
            "encoding": {
              "x": {
                "title": null,
                "type": "quantitative",
                "field": "census_percentage",
                "sort": "ascending",
                "axis": {
                  "type": "quantitative",
                  "format": ".1%",
                  "grid": true,
                  "labelFlush": false,
                  "labels": true
                },
                "scale": {"domain": [0,0.13]}
              },
              "y": {
                "title": null,
                "type": "ordinal",
                "field": "age_group",
                "axis": null
              },
              "stroke": {
                "value": "black"
              },
              "strokeWidth": {
                "value": 2
              },
              "fillOpacity": {
                "value": 0
              }
            }
          }
        ],
        "encoding": {
          "tooltip": [
            {
              "format": ".1%",
              "type": "quantitative",
              "field": "percentage"
            },
            {
              "format": ".1%",
              "type": "quantitative",
              "field": "census_percentage"
            }
          ]
        },

        "resolve": {
          "scale": {
            "x": "shared",
            "y": "shared"
          }
        }
      }
    ]
  }

}
