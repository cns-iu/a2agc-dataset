{
	"$schema": "https://vega.github.io/schema/vega-lite/v4.json",
	"config": {
		"mark": {
			"tooltip": null
		},
	    "view": {
      		"stroke": "transparent"
    	}
	},
	"data": {
		"url": "../data/visualization4/data.csv"
	},
	"vconcat": [
		{
			"hconcat": [
				{
					"height": 200,
					"encoding": {
						"color": {
							"legend": null,
							"field": "deaths_binned",
							"title": "Deaths",
							"type": "quantitative"
						},
						"tooltip": [
							{
								"field": "TOTAL_DEATHS",
								"title": "Deaths",
								"type": "ordinal"
							},
							{
								"field": "group",
								"title": "Age Group",
								"type": "ordinal"
							},
							{
								"field": "YEAR",
								"title": "YEAR",
								"type": "ordinal"
							}
						],
						"x": {
							"field": "YEAR",
							"title": "Year",
							"type": "ordinal",
							"axis": { 
								"labelAngle": 0
							},
							"scale": {
								"domain": [
									2010,
									2011,
									2012,
									2013,
									2014,
									2015,
									2016,
									2017,
									2018
								]
							}
						},
						"y": {
							"axis": {
								"labels": true
							},
							"field": "group",
							"title": "Age Group",
							"type": "ordinal",
							"scale": { 
								"reverse": true,
								"domain": [
									"0-9",
									"10-19",
									"20-29",
									"30-39",
									"40-49",
									"50-59",
									"60-69",
									"70+"
								] 
							}
						}
					},
					"mark": "rect",
					"title": "All Substances",
					"transform": [
						{
							"filter": {
								"selection": "pts"
							}
						},
						{
							"filter": {
								"selection": "year_selection"
							}
						},
						{
							"filter": {"selection": "deaths_binned"}
						},
						{
							"joinaggregate": [
								{
									"as": "TOTAL_DEATHS",
									"field": "CASE_NUMBER",
									"op": "distinct"
								}
							],
							"groupby": [
								"AGE_GROUP",
								"YEAR"
							]
						},
						{
							"as": "deaths_max69",
							"calculate": "min(69, datum.TOTAL_DEATHS)"
						},
						{
							"bin": {
								"anchor": 0,
								"maxbins": 7,
								"step": 10,
								"extent": [0, 69]
							},
							"field": "deaths_max69",
							"as": "deaths_binned"
						},
						{
							"as": "group",
							"calculate": "if(toString(10 * datum.AGE_GROUP) < 70, toString(10 * datum.AGE_GROUP) + \"-\" + toString(10 * datum.AGE_GROUP + 9), '70+')"
						}
					],
					"width": 500
				},
				{
					"height": 200,
					"title": "All Substances",
					"mark": "bar",
					"encoding": {
						"x": {
							"aggregate": "distinct",
							"field": "CASE_NUMBER",
							"type": "quantitative",
							"title": "Deaths"
						},
						"y": {
							"axis": {
								"labels": true
							},
							"field": "group",
							"title": "Age Group",
							"type": "ordinal",
							"scale": { "reverse": true }
						},
						"tooltip": [
							{
								"aggregate": "distinct",
								"field": "CASE_NUMBER",
								"type": "quantitative",
								"title": "Total"
							},
							{
								"field": "group",
								"title": "Age Group",
								"type": "ordinal"
							}
						]
					},
					"transform": [
						{
							"filter": {
								"selection": "pts"
							}
						},
						{
							"filter": {
								"selection": "year_selection"
							}
						},
						{
							"as": "group",
							"calculate": "if(toString(10 * datum.AGE_GROUP) < 70, toString(10 * datum.AGE_GROUP) + \"-\" + toString(10 * datum.AGE_GROUP + 9), '70+')"
						}
					],
					"width": 500
				}
			]
		},
		{
			"hconcat": [
				{
					"mark": "line",
					"width": 900,
					"height": 200,
					"title": "Update Graphs Using Filters Below",
					"encoding": {
						"color": { "value": "#6ea7ef" },
						"x": {
							"field": "YEAR",
							"type": "quantitative",
							"title": "Year",
							"axis": {
								"titleFontSize": 14,
								"tickColor": "#757575",
								"domainColor": "#757575",
								"labelFlush": false,
								"labelAngle": 0,
								"labelExpr": "[datum.value%1 == 0 ? datum.value : '']",
								"gridDash": {
                  					"condition": {
										"test": "(datum.value+.5)%1 == 0", 
										"value": [2,2]
									},
				  					"value": []
                				},
								"gridColor": {
									"condition": {
										"test": "datum.value%1 == 0", 
										"value": "#BDBDBD"
									},
									"value": "#e0e0e0"
								}
							},
							"scale": {
								"domainMax": 2018
							}
						},
						"y": {
							"field": "TOTAL_DEATHS",
							"type": "quantitative",
							"title": "# Deaths",
							"axis": {
								"titleFontSize": 14,
								"gridColor": "#e0e0e0",
								"tickColor": "#757575",
								"domainColor": "#757575",
								"gridOpacity": {
									"condition": {"test": {"field": "index", "equal": 1}, "value": 0},
									"value": 1
								},
								"tickOpacity": {
									"condition": {"test": {"field": "index", "equal": 1}, "value": 0},
									"value": 1
								},
								"labelFontSize": {
									"condition": {"test": {"field": "index", "equal": 1}, "value": 0},
									"value": 10
								}
							}
						}
					},
					"selection": {
						"year_selection": {
							"type": "interval",
							"encodings": ["x"],
							"mark": {"fill": "#6ea7ef", "fillOpacity": 0.15}
						}
					},
					"transform": [

						{
							"aggregate": [
								{
									"as": "TOTAL_DEATHS",
									"field": "CASE_NUMBER",
									"op": "distinct"
								}
							],
							"groupby": ["YEAR"]
						}
					]
				},
				{
					"data": {
						"sequence": {
							"start": 0,
							"stop": 65,
							"step": 10,
							"as": "deaths_binned"
						}
					},
					"transform": [
						{
						"calculate": "if(datum.low < 60, datum.low + '-' + (datum.low + 9), '60+')",
						"as": "label"
						}
					],
					"mark": "rect",
					"width": 70,
					"height": 200,
					"selection": {
						"deaths_binned": {
							"type": "single",
							"fields": [
								"deaths_binned"
							]
						}
					},
					"encoding": {
						"x": {
							"type": "nominal",
							"field": "YEAR",
							"title": "# Deaths",
							"axis": {
								"labels": false,
								"ticks": false
							}
						},
						"y": {
							"field": "deaths_binned",
							"type": "ordinal",
							"scale": {"reverse": true}
						},
						"color": {
							"condition": {
								"legend": null,
								"selection": "deaths_binned",
								"field": "deaths_binned",
								"scale": {
									"scheme": "yellowgreenblue"
								}
							}
						}
					}
				},
				{
					"data": {
						"values": [
							{
								"SUBSTANCE_NAME": "Heroin",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Heroin",
								"SEX": "F"
							},
							{
								"SUBSTANCE_NAME": "Methamphetamine",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Methamphetamine",
								"SEX": "F"
							},
							{
								"SUBSTANCE_NAME": "Fentanyl",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Fentanyl",
								"SEX": "F"
							},
							{
								"SUBSTANCE_NAME": "Any Opioid",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Any Opioid",
								"SEX": "F"
							},
							{
								"SUBSTANCE_NAME": "Benzodiazepine",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Benzodiazepine",
								"SEX": "F"
							},
							{
								"SUBSTANCE_NAME": "Cocaine",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Cocaine",
								"SEX": "F"
							},
							{
								"SUBSTANCE_NAME": "Prescription Opioid",
								"SEX": "M"
							},
							{
								"SUBSTANCE_NAME": "Prescription Opioid",
								"SEX": "F"
							}
						]
					},
					"mark": "rect",
					"width": 70,
					"height": 200,
					"selection": {
						"pts": {
							"type": "multi",
							"fields": [
								"SUBSTANCE_NAME",
								"SEX"
							]
						}
					},
					"encoding": {
						"x": {
							"field": "SEX",
							"title": "Sex",
							"type": "ordinal"
						},
						"y": {
							"field": "SUBSTANCE_NAME",
							"title": "Substance Name",
							"type": "ordinal"
						},
						"color": {
							"condition": {
								"legend": null,
								"selection": "pts",
								"aggregate": "count",
								"type": "quantitative"
							},
							"value": "grey"
						}
					}
				}
			]
		}
	]
}