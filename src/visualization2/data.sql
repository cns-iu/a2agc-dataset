WITH
  P AS (
	SELECT CASE_NUMBER, 
	CASE
        WHEN max(OPIOID_FLAG) + max(BENZO_FLAG) > 0 THEN 1 ELSE 0
    END as OPIOID_PRESCRIPTION
	FROM medications
	GROUP BY CASE_NUMBER
  ),
  O AS ( 
	SELECT CASE_NUMBER, 
	CASE
        WHEN max(OVERDOSE_CC_MOI) + max(NALOXONE_DUMMY) > 0 THEN 1 ELSE 0
    END as OVERDOSE
	FROM ems_incidents
	GROUP BY CASE_NUMBER
  ),
  J AS ( 
	SELECT CASE_NUMBER, 1 AS JUSTICE_INVOLVEMENT
	FROM incarcerations
	GROUP BY CASE_NUMBER
  ),
  H AS (
	SELECT CASE_NUMBER, 1 AS HEALTH_DATA
	FROM encounters
	GROUP BY CASE_NUMBER
  ),
  CN_POJH AS (
	SELECT D.CASE_NUMBER,
	  coalesce(OPIOID_PRESCRIPTION, 0) AS OPIOID_PRESCRIPTION,
	  coalesce(OVERDOSE, 0) AS OVERDOSE,
	  coalesce(JUSTICE_INVOLVEMENT, 0) AS JUSTICE_INVOLVEMENT,
	  coalesce(HEALTH_DATA, 0) AS HEALTH_DATA
	FROM deaths AS D 
	  LEFT OUTER JOIN P ON D.CASE_NUMBER = P.CASE_NUMBER
	  LEFT OUTER JOIN O ON D.CASE_NUMBER = O.CASE_NUMBER
	  LEFT OUTER JOIN J ON D.CASE_NUMBER = J.CASE_NUMBER
	  LEFT OUTER JOIN H ON D.CASE_NUMBER = H.CASE_NUMBER
  ),
  labels AS (
	SELECT CASE_NUMBER, 
	CASE
	  WHEN OPIOID_PRESCRIPTION + OVERDOSE = 2 THEN "Rx + OD"
	  WHEN OPIOID_PRESCRIPTION = 1 THEN "Rx"
	  WHEN OVERDOSE = 1 THEN "OD"
	  ELSE "∅"
	END as A,
	CASE
	  WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA = 2 THEN "Jail + HD"
	  WHEN JUSTICE_INVOLVEMENT = 1 THEN "Jail"
	  WHEN HEALTH_DATA = 1 THEN "HD"
	  ELSE "∅"
	END as B,
	CASE
	  WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OPIOID_PRESCRIPTION + OVERDOSE = 4 THEN "Rx + OD + Jail + HD"
	  WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OVERDOSE = 3 THEN "OD + Jail + HD"
	  WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OPIOID_PRESCRIPTION = 3 THEN "Rx + Jail + HD"
	  WHEN JUSTICE_INVOLVEMENT + OVERDOSE + OPIOID_PRESCRIPTION = 3 THEN "Rx + OD + Jail"
	  WHEN HEALTH_DATA + OVERDOSE + OPIOID_PRESCRIPTION = 3 THEN "Rx + OD + HD"
	  WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA = 2 THEN "Jail + HD"
	  WHEN JUSTICE_INVOLVEMENT + OVERDOSE = 2 THEN "OD + Jail"
	  WHEN JUSTICE_INVOLVEMENT + OPIOID_PRESCRIPTION = 2 THEN "Rx + Jail"
	  WHEN HEALTH_DATA + OPIOID_PRESCRIPTION = 2 THEN "Rx + HD"
  	  WHEN OPIOID_PRESCRIPTION + OVERDOSE = 2 THEN "Rx + OD"
	  WHEN HEALTH_DATA + OVERDOSE = 2 THEN "OD + HD"
	  WHEN JUSTICE_INVOLVEMENT = 1 THEN "Jail"
	  WHEN OVERDOSE = 1 THEN "OD"
	  WHEN OPIOID_PRESCRIPTION = 1 THEN "Rx"
	  WHEN HEALTH_DATA = 1 THEN "HD"
	  ELSE "∅"
	END as subset
	FROM CN_POJH
  )

SELECT
  A AS "Touchpoint A",
  B AS "Touchpoint B",
  SUM(cnt) AS Deaths,
  subset AS "Set"
FROM (
  SELECT A, B, COUNT(*) as cnt, subset FROM labels GROUP BY A, B
  UNION
  SELECT 'Rx + OD' AS A, '∅' AS B, 0 AS cnt, 'Rx + OD' AS subset
  UNION
  SELECT 'Rx + OD' AS A, 'Jail' AS B, 0 AS cnt, 'Rx + OD + Jail' AS subset
  UNION
  SELECT 'Rx' AS A, 'Jail' AS B, 0 AS cnt, 'Rx + Jail' AS subset
) AS data
GROUP BY A, B, subset
ORDER BY Deaths DESC;
