WITH
  P AS (
	SELECT CASE_NUMBER, 
	CASE
        WHEN max(OPIOID_FLAG) + max(BENZO_FLAG) > 0 THEN 1 ELSE 0
    END as OPIOID_PRESCRIPTION
	FROM medications
	GROUP BY CASE_NUMBER
  ),
  O AS ( 
	SELECT CASE_NUMBER, 
	CASE
        WHEN max(OVERDOSE_CC_MOI) + max(NALOXONE_DUMMY) > 0 THEN 1 ELSE 0
    END as OVERDOSE
	FROM ems_incidents
	GROUP BY CASE_NUMBER
  ),
  J AS ( 
	SELECT CASE_NUMBER, 1 AS JUSTICE_INVOLVEMENT
	FROM incarcerations
	GROUP BY CASE_NUMBER
  ),
  H AS (
	SELECT CASE_NUMBER, 1 AS HEALTH_DATA
	FROM encounters
	GROUP BY CASE_NUMBER
  ),
  CN_POJH AS (
	SELECT D.CASE_NUMBER,
		coalesce(OPIOID_PRESCRIPTION, 0) AS OPIOID_PRESCRIPTION,
		coalesce(OVERDOSE, 0) AS OVERDOSE,
		coalesce(JUSTICE_INVOLVEMENT, 0) AS JUSTICE_INVOLVEMENT,
		coalesce(HEALTH_DATA, 0) AS HEALTH_DATA
	FROM deaths AS D 
		LEFT OUTER JOIN P ON D.CASE_NUMBER = P.CASE_NUMBER
		LEFT OUTER JOIN O ON D.CASE_NUMBER = O.CASE_NUMBER
		LEFT OUTER JOIN J ON D.CASE_NUMBER = J.CASE_NUMBER
		LEFT OUTER JOIN H ON D.CASE_NUMBER = H.CASE_NUMBER
  )

  SELECT
  	OPIOID_PRESCRIPTION AS "Opioid Prescription",
  	OVERDOSE AS "Overdose",
	JUSTICE_INVOLVEMENT AS "Justice Involvement",
	HEALTH_DATA AS "Health Data", COUNT(*) AS count
  FROM CN_POJH
  GROUP BY 
  	OPIOID_PRESCRIPTION,
	OVERDOSE,
	JUSTICE_INVOLVEMENT,
	HEALTH_DATA
  ORDER BY count DESC;
