WITH
  P AS (
	SELECT CASE_NUMBER, 
	CASE
        WHEN max(OPIOID_FLAG) + max(BENZO_FLAG) > 0 THEN 1 ELSE 0
    END as OPIOID_PRESCRIPTION
	FROM medications
	GROUP BY CASE_NUMBER
  ),
  O AS ( 
	SELECT CASE_NUMBER, 
	CASE
        WHEN max(OVERDOSE_CC_MOI) + max(NALOXONE_DUMMY) > 0 THEN 1 ELSE 0
    END as OVERDOSE
	FROM ems_incidents
	GROUP BY CASE_NUMBER
  ),
  J AS ( 
	SELECT CASE_NUMBER, 1 AS JUSTICE_INVOLVEMENT
	FROM incarcerations
	GROUP BY CASE_NUMBER
  ),
  H AS (
	SELECT CASE_NUMBER, 1 AS HEALTH_DATA
	FROM encounters
	GROUP BY CASE_NUMBER
  ),
  CN_POJH AS (
	SELECT D.CASE_NUMBER,
		coalesce(OPIOID_PRESCRIPTION, 0) AS OPIOID_PRESCRIPTION,
		coalesce(OVERDOSE, 0) AS OVERDOSE,
		coalesce(JUSTICE_INVOLVEMENT, 0) AS JUSTICE_INVOLVEMENT,
		coalesce(HEALTH_DATA, 0) AS HEALTH_DATA
	FROM deaths AS D 
		LEFT OUTER JOIN P ON D.CASE_NUMBER = P.CASE_NUMBER
		LEFT OUTER JOIN O ON D.CASE_NUMBER = O.CASE_NUMBER
		LEFT OUTER JOIN J ON D.CASE_NUMBER = J.CASE_NUMBER
		LEFT OUTER JOIN H ON D.CASE_NUMBER = H.CASE_NUMBER
  ),
	labels AS (
		SELECT CASE_NUMBER, 
		CASE
			WHEN OPIOID_PRESCRIPTION + OVERDOSE = 2 THEN "P∩O"
			WHEN OPIOID_PRESCRIPTION = 1 THEN "Opioid Prescription(P)"
			WHEN OVERDOSE = 1 THEN "Overdose(O)"
			ELSE "∅"
		END as A,
		CASE
			WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA = 2 THEN "J∩H"
			WHEN JUSTICE_INVOLVEMENT = 1 THEN "Justice Involvement(J)"
			WHEN HEALTH_DATA = 1 THEN "Health Data(H)"
			ELSE "∅"
		END as B,
		CASE
			WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OPIOID_PRESCRIPTION + OVERDOSE = 4 THEN "P∩O∩J∩H"
			WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OVERDOSE = 3 THEN "O∩J∩H"
			WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OPIOID_PRESCRIPTION = 3 THEN "P∩J∩H"
			WHEN JUSTICE_INVOLVEMENT + OVERDOSE + OPIOID_PRESCRIPTION = 3 THEN "P∩O∩J"
			WHEN HEALTH_DATA + OVERDOSE + OPIOID_PRESCRIPTION = 3 THEN "P∩O∩H"
			WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA = 2 THEN "J∩H"
			WHEN JUSTICE_INVOLVEMENT + OVERDOSE = 2 THEN "O∩J"
			WHEN JUSTICE_INVOLVEMENT + OPIOID_PRESCRIPTION = 2 THEN "P∩J"
			WHEN HEALTH_DATA + OPIOID_PRESCRIPTION = 2 THEN "P∩H"
			WHEN OPIOID_PRESCRIPTION + OVERDOSE = 2 THEN "P∩O"
			WHEN HEALTH_DATA + OVERDOSE = 2 THEN "O∩H"
			WHEN JUSTICE_INVOLVEMENT = 1 THEN "J"
			WHEN OVERDOSE = 1 THEN "O"
			WHEN OPIOID_PRESCRIPTION = 1 THEN "P"
			WHEN HEALTH_DATA = 1 THEN "H"
			ELSE "∅"
		END as subset
		FROM CN_POJH
  	)

SELECT
	A AS "Touchpoint A",
	B AS "Touchpoint B",
	COUNT(*) AS count,
	subset AS "Set"
FROM labels
GROUP BY 
  	A, B
ORDER BY count DESC;

