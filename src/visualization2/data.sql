WITH
  P AS (
    SELECT CASE_NUMBER,
    CASE
      WHEN max(OPIOID_FLAG) + max(BENZO_FLAG) > 0 THEN 1 ELSE 0
    END AS OPIOID_PRESCRIPTION
    FROM medications
    GROUP BY CASE_NUMBER
  ),
  O AS ( 
    SELECT CASE_NUMBER,
    CASE
      WHEN max(OVERDOSE_CC_MOI) + max(NALOXONE_DUMMY) > 0 THEN 1 ELSE 0
    END AS OVERDOSE
    FROM ems_incidents
    GROUP BY CASE_NUMBER
  ),
  J AS ( 
    SELECT CASE_NUMBER, 1 AS JUSTICE_INVOLVEMENT
    FROM incarcerations
    GROUP BY CASE_NUMBER
  ),
  H AS (
    SELECT CASE_NUMBER, 1 AS HEALTH_DATA
    FROM encounters
    GROUP BY CASE_NUMBER
  ),
  CN_POJH AS (
    SELECT D.CASE_NUMBER, DOD,
      coalesce(OPIOID_PRESCRIPTION, 0) AS OPIOID_PRESCRIPTION,
      coalesce(OVERDOSE, 0) AS OVERDOSE,
      coalesce(JUSTICE_INVOLVEMENT, 0) AS JUSTICE_INVOLVEMENT,
      coalesce(HEALTH_DATA, 0) AS HEALTH_DATA
    FROM deaths AS D 
      LEFT OUTER JOIN P ON D.CASE_NUMBER = P.CASE_NUMBER
      LEFT OUTER JOIN O ON D.CASE_NUMBER = O.CASE_NUMBER
      LEFT OUTER JOIN J ON D.CASE_NUMBER = J.CASE_NUMBER
      LEFT OUTER JOIN H ON D.CASE_NUMBER = H.CASE_NUMBER
  ),
  labels AS (
    SELECT CASE_NUMBER, DOD, TRUE = 1,
    CASE
      WHEN OPIOID_PRESCRIPTION + OVERDOSE = 2 THEN "Rx + OD"
      WHEN OPIOID_PRESCRIPTION = 1 THEN "Rx"
      WHEN OVERDOSE = 1 THEN "OD"
      ELSE "∅"
    END AS A,
    CASE
      WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA = 2 THEN "Jail + Health"
      WHEN JUSTICE_INVOLVEMENT = 1 THEN "Jail"
      WHEN HEALTH_DATA = 1 THEN "Health"
      ELSE "∅"
    END AS B,
    CASE
      WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OPIOID_PRESCRIPTION + OVERDOSE = 4 THEN "Rx + OD + Jail + Health"
      WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OVERDOSE = 3 THEN "OD + Jail + Health"
      WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA + OPIOID_PRESCRIPTION = 3 THEN "Rx + Jail + Health"
      WHEN JUSTICE_INVOLVEMENT + OVERDOSE + OPIOID_PRESCRIPTION = 3 THEN "Rx + OD + Jail"
      WHEN HEALTH_DATA + OVERDOSE + OPIOID_PRESCRIPTION = 3 THEN "Rx + OD + Health"
      WHEN JUSTICE_INVOLVEMENT + HEALTH_DATA = 2 THEN "Jail + Health"
      WHEN JUSTICE_INVOLVEMENT + OVERDOSE = 2 THEN "OD + Jail"
      WHEN JUSTICE_INVOLVEMENT + OPIOID_PRESCRIPTION = 2 THEN "Rx + Jail"
      WHEN HEALTH_DATA + OPIOID_PRESCRIPTION = 2 THEN "Rx + Health"
      WHEN OPIOID_PRESCRIPTION + OVERDOSE = 2 THEN "Rx + OD"
      WHEN HEALTH_DATA + OVERDOSE = 2 THEN "OD + Health"
      WHEN JUSTICE_INVOLVEMENT = 1 THEN "Jail"
      WHEN OVERDOSE = 1 THEN "OD"
      WHEN OPIOID_PRESCRIPTION = 1 THEN "Rx"
      WHEN HEALTH_DATA = 1 THEN "Health"
      ELSE "∅"
    END AS subset
    FROM CN_POJH
  )

SELECT
  CASE_NUMBER,
  A AS "Touchpoint A",
  B AS "Touchpoint B",
  DOD as "DOD",
  subset AS "Set",
  TRUE as "True"
FROM (
  SELECT CASE_NUMBER, A, B, DOD, subset, TRUE FROM labels
  -- UNION
  -- SELECT 1 AS CASE_NUMBER, 'Rx + OD' AS A, '∅' AS B, null AS MIN_DATE, 'Rx + OD' AS subset, 0 AS TRUE
  -- UNION
  -- SELECT 2 AS CASE_NUMBER, 'Rx + OD' AS A, 'Jail' AS B, null AS MIN_DATE, 'Rx + OD + Jail' AS subset, 0 AS TRUE
  -- UNION
  -- SELECT 3 AS CASE_NUMBER, 'Rx' AS A, 'Jail' AS B, null AS MIN_DATE, 'Rx + Jail' AS subset, 0 AS TRUE
) AS data
ORDER BY CASE_NUMBER;
