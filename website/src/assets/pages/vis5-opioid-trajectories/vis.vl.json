{
  "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
  "padding": {"top": 50},
  "config": {
    "view": {"strokeOpacity": 0}
  },

  "data": {
    "url": "assets/generated/visualization5/data.csv",
    "format": {
      "type": "csv",
      "parse": {
        "PERIOD": "date"
      }
    }
  },

  "transform": [
    {
      "calculate": "datum.Set === '∅' ? '1' : ''",
      "as": "none"
    }
  ],

  "hconcat": [
    {
      "title": {
        "text": "Filter By",
        "color": "#9e9e9e",
        "dy": 20
      },
      "spacing": 0,
      "vconcat": [
        {
          "title": {
            "text": "Rx",
            "dx": -20,
            "dy": 45
          },
          "mark": {"type": "text", "dy": 45},
          "data": {"values": [
            {"idx": 0, "label": "True", "P": "1", "True": "1"},
            {"idx": 1, "label": "False", "P": "", "True": "1"}
          ]},
          "selection": {
            "prescription_selection": {
              "type": "single",
              "fields": [
                "P", "True"
              ],
              "bind": {"legend": "click"}
            }
          },
          "encoding": {
            "opacity": {
              "condition": {"selection": "prescription_selection", "value": 1}, "value": 0.3
            },
            "text": {
              "type": "nominal",
              "field": "label"
            },
            "y": {
              "field": "idx", 
              "type": "ordinal",
              "axis": null
            }
          }
        },
        {
          "title": {
            "text": "OD",
            "dx": -20,
            "dy": 35
          },
          "mark": {"type": "text", "dy": 35},
          "data": {"values": [
            {"idx": 0, "label": "True", "O": "1", "True": "1"},
            {"idx": 1, "label": "False", "O": "", "True": "1"}
          ]},
          "selection": {
            "overdose_selection": {
              "type": "single",
              "fields": [
                "O", "True"
              ]
            }
          },
          "encoding": {
            "opacity": {"condition": {"selection": "overdose_selection", "value": 1}, "value": 0.3},
            "text": {
              "type": "nominal",
              "field": "label"
            },
            "y": {
              "field": "idx", 
              "type": "ordinal",
              "axis": null
            }
          }
        },
        {
          "title": {
            "text": "Jail",
            "dx": -20,
            "dy": 35
          },
          "mark": {"type": "text", "dy": 35},
          "data": {"values": [
            {"idx": 0, "label": "True", "J": "1", "True": "1"},
            {"idx": 1, "label": "False", "J": "", "True": "1"}
          ]},
          "selection": {
            "jail_selection": {
              "type": "single",
              "fields": [
                "J", "True"
              ]
            }
          },
          "encoding": {
            "opacity": {"condition": {"selection": "jail_selection", "value": 1}, "value": 0.3},
            "text": {
              "type": "nominal",
              "field": "label"
            },
            "y": {
              "field": "idx", 
              "type": "ordinal",
              "axis": null
            }
          }
        },
        {
          "title": {
            "text": "Health",
            "dx": -20,
            "dy": 35
          },
          "mark": {"type": "text", "dy": 35},
          "data": {"values": [
            {"idx": 0, "label": "True", "H": "1", "True": "1"},
            {"idx": 1, "label": "False", "H": "", "True": "1"}
          ]},
          "selection": {
            "health_selection": {
              "type": "single",
              "fields": [
                "H", "True"
              ]
            }
          },
          "encoding": {
            "opacity": {"condition": {"selection": "health_selection", "value": 1}, "value": 0.3},
            "text": {
              "type": "nominal",
              "field": "label"
            },
            "y": {
              "field": "idx", 
              "type": "ordinal",
              "axis": null
            }
          }
        },
        {
          "title": {
            "text": "∅",
            "dx": -20,
            "dy": 35
          },
          "mark": {"type": "text", "dy": 35},
          "data": {"values": [
            {"idx": 0, "label": "True", "none": "1", "True": "1"},
            {"idx": 1, "label": "False", "none": "", "True": "1"}
          ]},
          "selection": {
            "none_selection": {
              "type": "single",
              "fields": [
                "none", "True"
              ]
            }
          },
          "encoding": {
            "opacity": {"condition": {"selection": "none_selection", "value": 1}, "value": 0.3},
            "text": {
              "type": "nominal",
              "field": "label"
            },
            "y": {
              "field": "idx", 
              "type": "ordinal",
              "axis": null
            }
          }
        }
      ]
    },
    {
      "vconcat": [
        {
          "height": 600,
          "transform": [
            {"filter": { "selection": "period" }},
            {"filter": {"and": [
              {"selection": "prescription_selection"},
              {"selection": "overdose_selection"},
              {"selection": "jail_selection"},
              {"selection": "health_selection"},
              {"selection": "none_selection"}
            ]}}
          ],
          "encoding": {
            "y": {
              "field": "Touchpoint A", 
              "type": "quantitative",
              "title": null, 
              "scale": {
                "domain": [-0.5,3.5]
              },
              "axis": {
                "grid": false,
                "domain": false,
                "labels": false,
                "ticks": false
              }
            },
            "x": {
              "field": "Touchpoint B",
              "type": "quantitative",
              "title": null,
              "scale": {
                "domain": [-0.5,3.5]
              },
              "axis": {
                "grid": false,
                "domain": false,
                "labels": false,
                "ticks": false
              }
            }
          },
          "layer": [
            {
              "width": 799,
              "transform": [
                {
                  "aggregate": [{"op": "sum", "field": "True", "as": "sum"}], "groupby": ["Touchpoint A", "Touchpoint B"]
                }
              ],
              "mark": {"type": "circle", "yOffset": 10},
              "encoding": {
                "tooltip": [
                  {
                    "field": "label",
                    "title": "Set",
                    "type": "ordinal"
                  },
                  {
                    "field": "sum",
                    "title": "Deaths",
                    "type": "quantitative"
                  }
                ],
                "size": {
                  "field": "sum",
                  "type": "quantitative",
                  "scale": {"range": [0, 6000]},
                  "legend": null
                },
                "color": {
                  "field": "sum",
                  "type": "quantitative",
                  "scale": {
                    "type": "sqrt", 
                    "scheme": "blues"
                  }
                }
              }
            },
            {
              "transform": [
                {
                  "aggregate": [{
                  "op": "max",
                  "field": "Set",
                  "as": "label"
                  }],
                  "groupby": ["Touchpoint A", "Touchpoint B"]
                }
              ],
              "mark": {"type": "text", "dy": -65, "fontSize": 16},
              "encoding": {
                "text": {"field": "label", "type": "nominal"}
              }
            },
            {
              "mark": {"type": "text", "fontSize": 0},
              "encoding": {
                "color": {
                  "title": "Legend",
                  "aggregate": "sum",
                  "field": "True",
                  "type": "quantitative",
                  "legend": {
                    "labelOverlap": false,
                    "orient": "none",
                    "legendX": -30,
                    "legendY": 400,
                    "titleAlign": "center",
                    "titlePadding": 10,
                    "gradientLength": 150,
                    "labelFontSize": 8,
                    "labelOffset": 8
                  }
                }
              }
            },
            {
              "transform": [
                {
                  "aggregate": [{
                  "op": "sum",
                  "field": "True",
                  "as": "sum"
                  }],
                  "groupby": ["Touchpoint A", "Touchpoint B"]
                }
              ],
              "mark": {"type": "text", "dy": -45, "fontStyle": "bold", "fontSize": 16},
              "encoding": {
                "text": {"field": "sum", "type": "quantitative"}
              }
            }
          ]
        },

        {
          "title": {
            "text": "Select Date Range to Update Datasets",
            "align": "right",
            "dx": -160,
            "dy": -20,
            "fontSize": 16
          },
          "width": 800,
          "height": 150,
          "view": {
            "strokeOpacity": 0
          },
          "layer": [
            {
              "mark": {
                "type": "line"
              },
              "selection": {
                "period": {
                  "type": "interval", 
                  "encodings": ["x"],

                  "mark": {"fill": "#6ea7ef", "fillOpacity": 0.15}
                }
              },
              "encoding": {
                "x": {
                  "field": "PERIOD",
                  "type": "temporal",
                  "title": "Year",
                  "axis": {
                    "minExtent": 30,
                    "titleFontSize": 14,
                    "tickColor": "#757575",
                    "domainColor": "#757575",
                    "labelFlush": false,
                    "labelExpr": "[timeFormat(datum.value, '%m') == '01' ? timeFormat(datum.value, '%Y') : '']",
                    "gridDash": {
                      "condition": {"test": {"field": "value", "timeUnit": "month", "equal": 7}, "value": [2,2]},
                      "value": []
                    },
                    "gridColor": {
                      "condition": {"test": {"field": "value", "timeUnit": "month", "equal": 1}, "value": "#BDBDBD"},
                      "value": "#e0e0e0"
                    }
                  }
                },
                "y": {
                  "aggregate": "sum",
                  "field": "True",
                  "type": "quantitative",
                  "title": "# Deaths",
                  "axis": {
                    "titleFontSize": 14,
                    "gridColor": "#e0e0e0",
                    "tickColor": "#757575",
                    "domainColor": "#757575",
                    "gridOpacity": {
                      "condition": {"test": {"field": "index", "equal": 1}, "value": 0},
                      "value": 1
                    },
                    "tickOpacity": {
                      "condition": {"test": {"field": "index", "equal": 1}, "value": 0},
                      "value": 1
                    },
                    "labelFontSize": {
                      "condition": {"test": {"field": "index", "equal": 1}, "value": 0},
                      "value": 10
                    }
                  }
                },
                "color": {
                  "value": "#6ea7ef"
                }
              }
            }
          ]
        }
      ]
    }
  ]
}
