{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "config": {
    "axis": {
      "grid": true,
      "domain": false
    },
    "view": {
      "strokeOpacity": 0
    }
  },
  "data": { "name": "source" },
  "transform": [
    {
      "calculate": "round(12 * (datum.DOD - datum.PERIOD) / 3.154e+10)",
      "as": "TIME_BEFORE_DEATH"
    },
    {
      "filter": "datum.TIME_BEFORE_DEATH >= 0"
    }
  ],
  "hconcat": [
    {
      "title": " ",
      "width": 175,
      "height": 20,
      "transform": [
        {
          "fold": [
            "ALL_TYPES",
            "HEALTH_ENCOUNTERS",
            "OPIOID_PRESCRIPTIONS",
            "INCARCERATIONS",
            "OVERDOSES"
          ],
          "as": ["ENCOUNTER_TYPE", "COUNT"]
        },
        {
          "lookup": "ENCOUNTER_TYPE",
          "from": {
            "key": "ENCOUNTER_TYPE",
            "data": {
              "values":[
                {"ENCOUNTER_TYPE": "ALL_TYPES", "Encounter Type": "All Types"},
                {"ENCOUNTER_TYPE": "HEALTH_ENCOUNTERS", "Encounter Type": "Health Encounters"},
                {"ENCOUNTER_TYPE": "OPIOID_PRESCRIPTIONS", "Encounter Type": "Opiod Prescriptions"},
                {"ENCOUNTER_TYPE": "INCARCERATIONS", "Encounter Type": "Incarcerations"},
                {"ENCOUNTER_TYPE": "OVERDOSES", "Encounter Type": "Overdoses"}
              ]
            },
            "fields": ["Encounter Type"]
          }
        },
        {"filter": {"param": "rank", "empty": true}}
      ],
      "view": {"stroke": null},
      "mark": { "type": "area", "line": {"size": 0.05} },
      "encoding": {
        "row": {"field": "FINAL_RANK", "type": "quantitative", "bin": false, "header": null, "spacing": -20},
        "column": {"field": "Encounter Type", "type": "nominal", "bin": false, "spacing": 5},
        "x": {
          "field": "TIME_BEFORE_DEATH",
          "type": "quantitative",
          "title": null,
          "axis": {
            "orient": "top",
            "labelExpr": "datum.value / 12",
            "values": [
              0, 60, 120
            ]
          },
          "scale": {
            "domainMin": 0,
            "range": ["width", 0]
          }
        },
        "y": {
          "field": "COUNT",
          "type": "quantitative",
          "scale": {"zero": true, "type": "symlog"},
          "stack": "zero",
          "axis": {
            "title": null,
            "labels": false,
            "ticks": false,
            "grid": false
          }
        },
        "color": {
          "field": "Encounter Type",
          "type": "nominal",
          "title": "Encounter Type",
          "scale": {
            "domain": [
              "All Types",
              "Health Encounters",
              "Opiod Prescriptions",
              "Incarcerations",
              "Overdoses"
            ],
            "range": [
              "#e5dcc5ff",
              "#9fc893ff",
              "#fbdb39ff",
              "#1a659eff",
              "#bc1041ff"
            ]
          }
        },
        "tooltip": [
          { "field": "CASE_NUMBER", "type": "nominal" },
          { "field": "PERIOD", "type": "temporal", "timeUnit": "yearquarter", "title": "Quarter" },
          { "field": "Encounter Type", "type": "nominal", "title": "Encounter Type" },
          { "field": "COUNT", "type": "quantitative", "title": "# Days encounter occurred" },
          { "field": "TOTAL_HEALTH", "type": "quantitative"},
          { "field": "HEALTH_RANK", "type": "quantitative"},
          { "field": "AGE", "type": "quantitative"},
          { "field": "TOTAL_OVERDOSE", "type": "quantitative"},
          { "field": "OVERDOSE_RANK", "type": "quantitative"},
          { "field": "AGE", "type": "quantitative"},
          { "field": "AGE_RANK", "type": "quantitative"},
          { "field": "FINAL_RANK", "type": "quantitative"}
        ]
      }
    },
    {
      "width": 200,
      "height": 400,
      "view": {"stroke": null},
      "mark": "bar",
      "params": [
        {
          "name": "rank",
          "select": {
            "type": "interval",
            "on": {
              "type": "mousemove",
              "between": [
                {"type": "mousedown"},
                {"type": "mouseup"}
              ],
              "debounce": 1000
            },
            "encodings": ["y"],
            "mark": {"fill": "#6ea7ef", "fillOpacity": 0.15}
          }
        }
      ],
      "transform": [
        {
          "aggregate": [{
            "op": "max",
            "field": "TIME_BEFORE_DEATH",
            "as": "TIME_BEFORE_DEATH"
          }],
          "groupby": ["FINAL_RANK"]
        }
      ],
      "encoding": {
        "y": {"field": "FINAL_RANK", "axis": null},
        "x": {
          "field": "TIME_BEFORE_DEATH", "aggregate": "max",
          "title": "Years Before Death",
          "axis": {
            "orient": "top",
            "labelExpr": "datum.value / 12",
            "values": [
              0, 60, 120
            ]
          },
          "scale": {
            "domainMin": 0,
            "range": ["width", 0]
          }
        },
        "color": {"value": "#e5dcc5ff"}
      }
    },
    {
      "spacing": 0,
      "vconcat": [
        {
          "mark": "text",
          "data": {
            "values": []
          },
          "params": [
            {
              "name": "data_variable_selection",
              "select": {
                "type": "point"
              },
              "bind": "legend",
              "value": [
                {"LABEL": "Health encounters"}
              ]
            }
          ],
          "encoding": {
            "opacity": {
              "field": "LABEL",
              "title": "Select Data Variable",
              "type": "ordinal",
              "legend": {
                "orient": "right",
                "legendX": 0,
                "legendY": 0,
                "values": [
                  "Health encounters",
                  "Overdoses",
                  "Age"
                ],
                "symbolSize": 0
              }
            }
          }
        }
      ]
    }
  ],
  "datasets": {
    "source": []
  }
}
